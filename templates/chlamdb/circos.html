<!DOCTYPE html>


<html>
<head>
{% load static %}
{% load static %}
{% load crispy_forms_tags %}
<link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}" />
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.js'></script>
<script src="{% static 'js/circos.js' %}"></script>

{% include "chlamdb/header.html" %}
</head>
<body>

  <div class="container-fluid" id="main_container">
    <div class="row">
      <div id="wrapper">
          <div id="page-content-wrapper">
            <div class="row">
              <div class="col-lg-12">
                 {% include "chlamdb/menu.html" %}


                  <div class="panel panel-success" style="width:80%; top: 200px; margin: 10px 10px 10px 10px">
                      <div class="panel-heading" style="width:100%">
                          <h3 class="panel-title">Help</h3>
                      </div>
                      <p style="margin: 10px 10px 10px 10px"><h3>Circos plots indicating the presence(red scale)/absence(light blue) of homologous proteins in one or multiple other genomes. </h3>
                      Click on the circos plot to open a new windows with clickable version of the plot.
                       <ul id="circos_ul" style="list-style-type:disc;">  
                            <li>The first outer circle show contig/chromosome boundaries</li>
                            <li>The second and third circles show open reading frames from the reference genome (in gray)</li>
                            <ol>
                                <li>rRNA are colored in blue, tRNA in red</li>
                            </ol>
                            <li>Inner blue/red circle(s) incicate the presence(red scale)/absence(light blue) of homologous proteins in one or multiple other genomes</li>
                            <li>The last two inner circles show GC content (blue/red) and GC skew (blue/green)</li>
                            
                      </ul>
                      </p>
                  </div>
                  <div class="row">

                    {% block content %}
                    <form action="{% url "circos" %}" method="post" id="circos-form">
                        {% csrf_token %}
                        {% crispy form %}
                    </form>
                    {% endblock %}

                  </div>

                  <div id='heatmapChart' class='chartclass'></div>

              </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

{% include "chlamdb/style_menu.html" %}



<script type="text/javascript">

var width = 800;

var configuration = {
          innerRadius: width / 2 - 40,
          outerRadius: width / 2 - 30,
          ticks: {display: true},
          gap: 0,
          tooltipContent: function (d) {
          return `<h5> TEST: ${d.locus_tag}: ${d.value} % identity</h5>`
          },
          labels: {
            position: 'center',
            display: true,
            size: 0,
            color: 'red',
            radialOffset: 5
          },
		  ticks: {
			display: true,
			color: 'grey',
			spacing: 50000,
			labels: false,
			labelSpacing: 1,
			labelSuffix: 'Kb',
			labelDenominator: 1000,
			labelDisplay0: true,
			labelSize: '10px',
			labelColor: '#000000',
			labelFont: 'default',
			majorSpacing: 5,
			size: {
			  minor: 0,
			  major: 0,
			}
		  },
      events: {'click.alert': function (datum, index, nodes, event) {

            window.alert(datum.label)
      },
      }
}

var data = {{contigs_data|safe}}


var myCircos = new Circos({
    container: '#heatmapChart',
    width: 800,
    height: 800,
    defaultTrackWidth: 10
});




var heatmap_data_lst = {{heatmap_data_list|safe}} ;

myCircos.layout(data, configuration);

var i = 0;
for (var key in heatmap_data_lst) { 
    var heatmap_configuration = {
    innerRadius: 0.9 - (i * 0.1),
    outerRadius: 0.98 -(i * 0.1),
    min: 0,
    max: 100,
    color: 'YlOrRd',
    logScale: false,
    tooltipContent: function (d) {
        return `<h5>${d.locus_tag}: ${d.value} % identity</h5>`
      },
    events: {'click.alert': function (datum, index, nodes, event) {
      window.location='/locusx/' + datum.locus_tag;
      //window.alert(JSON.stringify(nodes[index]['__data__'].locus_tag))
            }
            }
    }
    i = i+1;
    myCircos.heatmap(key, heatmap_data_lst[key], heatmap_configuration);
}

myCircos.render();

</script>

</html>
